---
title: "JAS_DataManagementFor13Tokyo-20201017ver"
author: "kotdijian"
date: "2020年10月17日"
output:
  pdf_document:
       latex_engine: xelatex 
  html_document: default
  word_document: default
documentclass: bxjsarticle
classoption: xelatex,ja=standard
geometry: no
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
library("knitr")
knitr::opts_chunk$set(echo = TRUE)
Sys.setlocale("LC_ALL","Japanese") #Windowsにおけるエンコード問題解決用
```

------------------------------------------------------------------------

## 0.はじめに

これは、[考古学・文化財のためのデータサイエンス・サロンオンライン\#03
オープンリソースによる遺跡地図作成実習part2](https://3dlm.peatix.com/)の教材資料として作成されたRマークダウン・ドキュメントです。
-
[Rマークダウンとは?](https://kazutan.github.io/kazutanR/Rmd_intro.html)\
-
[RStudio公式によるRマークダウンチートシート](https://rstudio.com/wp-content/uploads/2016/11/Rmarkdown-cheatsheet-2.0_ja.pdf)

以下の内容を含みます。\
1. R/RStudioの基本操作\
2. データの読み込み\
3.

実習では、[東京都遺跡地図情報インターネット提供サービス](https://tokyo-iseki.metro.tokyo.lg.jp/)の収録情報を[リスト化したもの](https://github.com/kotdijian/JASOSR/tree/master/13Tokyo)を整理・加工するためのコードを通じて、Rによるデータ操作を学びます。

なお本資料は、東京学芸大学2020年度春学期開講「地域考古学B」課外補講のために作成したものをベースに、「考古学・文化財のためのデータサイエンス・サロン」向けに改変しました。

------------------------------------------------------------------------

## 1.Rとは何か

> R言語（あーるげんご）はオープンソース・フリーソフトウェアの統計解析向けのプログラミング言語及びその開発実行環境である。([日本語版Wikipedia「R言語」](https://ja.wikipedia.org/wiki/R%E8%A8%80%E8%AA%9E))

Rは統計計算処理とグラフィックスのためのフリーのソフトウェア環境です。([R公式サイトトップ](https://www.r-project.org/))

Rは統計計算処理とグラフィックスのための言語および環境です。(中略)Rは、線形・非線形モデリング、古典的統計検定、時系列分析、分類、クラスター分析など多様な統計処理とグラフィックスを提供し、非常に拡張性の高いものです。([R公式サイト「Rとは」](https://www.r-project.org/about.html))

R言語（あーるげんご）はオープンソース・フリーソフトウェアの統計解析向けのプログラミング言語及びその開発実行環境である。([日本語版Wikipedia「R言語」](https://ja.wikipedia.org/wiki/R%E8%A8%80%E8%AA%9E))

------------------------------------------------------------------------

## 2.R(とRStudio)の基本操作

### 2-1.関数(function)

Rの基本は**関数**(function)の組み合わせで行ないます。ここでの**関数**とは、与えられた入力(input)に対して定められた処理を行ない、結果を出力(output)するものです。

以下、RStudioを使用する前提で操作方法を確認します。

まず最初に、Consoleに`print("こんにちは")`と入力（またはコピーペースト）してみましょう。

`print()`は()内の内容を出力表示する関数です。""(ダブルクオーテーション)で囲んだ文字列を出力するほか、数値などを代入したオブジェクト(object)や、表(table)などを出力することもできます。

実行できたら""内に任意の文字列を入力して確認して見てください。

### 2-2.数値の計算とオブジェクト

次に、Consoleに`1 + 2`と入力してみましょう。

計算結果が直接表示されます。

それでは、以下を入力するとどうなるでしょうか?

`x <- 1`\
`y <- 2`\
`z <- x + y`

`x`, `y`,
`z`はそれぞれ**オブジェクト**です。**オブジェクト**とは、数値や文字列などのデータや計算結果を格納して保存しておくためのものです。

`<-`は、左側に示された**オブジェクト**に、右側の入力を格納することを指示する**代入演算子**です。

この3行の**コード**は、`x`に1、`y`に2を代入し、`z`に`x + y`の結果を代入するものです。

そしてこの3行のコードを実行しても、先ほどの計算(`1 + 2`)の時のように結果が表示されません。代わりに、右上の**Environment**ウインドウ(pane)に、`x`,
`y`, `z`と、それぞれの入力結果が表示されているはずです。

次に、'print(x)`と入力して見てください。`x`の値が表示されます。単に`x\`と入力するだけでも、同じ結果を得られます。

### 2-3.文字データと行列データ

オブジェクトには、数値だけでなく文字列を格納することができます。以下を入力して見てください。

`a <- "私の名前は"`\
`b <- "まだない"`\
`c <- paste(a,b)`\
`c`

`a`、`b`の内容は数値ではないので、四則演算を適用できません。()内の文字列を結合する`paste()`関数を使用します。

オブジェクトには、複数の数値や文字列を格納することもできます(行列またはベクトル)。`c(#,#,#)`のように記述します。以下のとおりに入力し、出力結果およびEnvironmentウインドウの内容確認しましょう。

`s <- c(1, 2, 3)`\
`t <- 4`\
`u <- s + t`\
`s`\
`s[2]`\
`u`

`d <- c("神奈川","千葉","埼玉")`\
`e <- "県"`\
`f <- paste(d, e)`\
`f[3]`

**Environment**ウインドウの`s`および`u`の項に表示される`num`は数値を示します。同じく`d`および`f`の項に表示される`chr`は文字列を示します。

数値行列に四則演算を適用すると、行列内の各項をそれぞれ計算した結果が、行列として返されます。

文字行列に`paste()`関数を適用すると、行列内の各項をそれぞれ結合した結果が、行列として返されます。

行列データを格納したオブジェクトのn番目のデータのみを示す場合はオブジェクト名に`[n]`を添えます。`s[2]`は、`s`の2番目のデータ、すなわち`2`を示します。

### 2-4.オブジェクトの消去

ここまでを理解できたら、いったん、操作練習で作成したオブジェクトを消去しましょう。

オブジェクトの消去には`rm()`関数を使用します。カッコ内に消去したいオブジェクト名を入力します。ここでは、すべてのオブジェクトをいったん消去するため、**Console**ウインドウに、`rm(list = ls())`と入力してください。**Environment**ウインドウのすべてのオブジェクトが消え、`Environment is empty`が表示されているのを確認してください。

------------------------------------------------------------------------

## 3.パッケージの準備

### 3-1.パッケージとは

Rには`base`と呼ばれる基本関数があります([BaseRチートシート日本語版](https://rpubs.com/keisato/base-r))

さらに基本関数を組み合わせて、より高度な操作を行なう関数を作成することができます。有用な関数を設定した[*パッケージ*(package)](https://syunsuke.github.io/r_beginners_guide/04_package.html)が多数開発され、提供されていることがRの特徴のひとつです。

これらのパッケージはR同様、オープンソースでありフリーです。CRAN
(**C**omprehensive **R** **A**rchive
**N**etwork)と呼ばれる公式のアーカイブのほか、**GitHub**等を通じて作成者が公開しているパッケージが多数あります。

今回は、**Tidyverse**、**rio**、**utf8**、**bit64**というパッケージを使用します。

### 3-2.パッケージのインストールとアクティベート

インストールされたパッケージは、Packagesウインドウに表示されます。

インストールしたRパッケージは、`library()`関数でアクティベートする必要があります。アクティベートされたパッケージは、Packagesウインドウでパッケージ名の前のボックスにチェックが入ります。

以下に、パッケージのチェックとインストール、アクティベートのコードを**コードチャンク**として示します。

```{r chunk1, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}
#パッケージチェックとインストール
if(!require("tidyverse")) install.packages('tidyverse', repos='http://cran.us.r-project.org') 
if(!require("rio")) install.packages('rio', repos='http://cran.us.r-project.org')  
if(!require("utf8")) install.packages("utf8", repos='http://cran.us.r-project.org') #UTF-8エンコーディング対応
if(!require("bit64")) install.packages("bit64", repos='http://cran.us.r-project.org') #UID13桁対応

#パッケージのアクティベート
library("tidyverse")
library("rio")
library("utf8")
library("bit64")

```

**コードチャンク**はRマークダウンの特徴的な機能のひとつで、文書の中にコードを実行可能なかたちで埋め込んだものです。

マークダウン文書中に、灰色の背景で区画された範囲が**コードチャンク**です。右上に右向きの緑三角の実行ボタン(`Run current chunk`)があり、これをクリックするとチャンク内のコードが全て実行されます。

11行のコードは、`if(!require("パッケージ名")) install.packages("パッケージ名", repos = "リポジトリURL")`として、必要とするパッケージがすでにインストールされているかどうかをチェックし、まだの場合はインストールを実行した後、`library()`でアクティベートするというコードです。

なお**コードチャンク**中に`#`を付されているのは`コメント`または`注釈`と呼ばれるもので、プログラムの実行に関係のないメモとして記述されるものです。

パッケージのインストールには時間がかかる場合があります。すでにインストール済みのパッケージは右下の**Packages**ウインドウに表示されるので、検索・確認して見てください。

すでに`tidyverse`、`rio`、`utf8`、`bit64`がインストール済みの場合は、157～160行目を選択し、`Ctrl+Enter`で実行してください。この方法で、チャンク全体ではなく選択範囲のコードのみを実行することができます。

アクティベートが完了したパッケージは、**Package**ウインドウのパッケージ名の左の四角にチェックマークが入ります。これにより、各パッケージに含まれる関数・機能が使用可能になります。

### 3-3. Tidyverseについて

[Tidyverse](https://www.tidyverse.org/))は、おそらく、データサイエンスまわりではもっとも多用されている、ある意味では必須のRパッケージでしょう。

**Tidyverse**は、データを取り込み、整然データ(Tidy
data)に加工して、分析や可視化に提供することを目的とするもので、以下のパッケージ群を含みます。\
- [tibble](https://tibble.tidyverse.org/): Tidyverse用のデータフレーム\
- [dplyr](https://dplyr.tidyverse.org/):
データフレーム(後述)操作のパッケージ\
- [tidyr](https://tidyr.tidyverse.org/):
整然データを作るためのパッケージ\
- [readr](https://readr.tidyverse.org/):
.csvなどの表データファイル読込のためのパッケージ\
- [stringr](https://stringr.tidyverse.org/):
文字列を操作するためのパッケージ\
- [purrr](https://purrr.tidyverse.org/): 繰り返し計算のためのパッケージ\
- [forcats](https://forcats.tidyverse.org/):
因子型(factor)データを扱うためのパッケージ\
- [ggplot2](https://ggplot2.tidyverse.org/): グラフ描画パッケージ

ここでは各パッケージの詳細には触れませんが、インターネット上で日本語のものを含む多数の解説が提供されています。検索して見てください。

#### 参考

-   [「R自学自習の基礎知識」HeavyWatal](https://heavywatal.github.io/rstats/intro.html)
-   [「Tidyverse」Nishii's
    Notebook](http://bcl.sci.yamaguchi-u.ac.jp/~jun/notebook/r/tidyverse/)

体系的に学習したい方のためには、**Tidyverse**の作者による著書 "*R for
Data Science*" の日本語版が刊行されています。 -
[『Rではじめるデータサイエンス』H.Wickham &
G.Grolemund,2017,オライリージャパン](https://amzn.to/3k2me28)

### 3-4.整然データ(tidy data)

**Tidyverse**の根幹は、**整然データ(tidy
data)**です。**整然データ**とは、`構造と意味が合致する`ものであり、Rをはじめとするデータの分析にもっとも適したかたちにデータを整えておくことが重要であるという考え方になります（参考：[「整然データとは何か」Colorless
Green Ideas](https://id.fnshr.info/2017/01/09/tidy-data-intro/))。

**整然データ**の要件は以下の通りです。\
- 一連の値(変数: variables、フィールドとも)が一つの列に収められている\
- 一組のデータセット(レコード)が一つの行に収められている\
-
一つの項目(行・列を構成するセル)には一つの値(文字でも数値でもよい)が収められている\
- 一つの列のデータ型は同一である

これは、内容が正規化され、全体が構造化された表と見なすことができます。

たとえば、以下のようなデータは整然データではありません。

#### 例1

| 遺跡名 | 報告書          | 時代                | 種別      |
|--------|-----------------|---------------------|-----------|
| A遺跡  | 報告書B         | 縄文時代            | 集落      |
| B遺跡  | 報告書C 報告書D | 旧石器時代 古墳時代 | 集落 墳墓 |

ここでは、報告書、時代、種別に複数の値が入っているセルがあります。これは例えば、以下のように整形されるべきです。

| 遺跡名 | 報告書  | 時代       | 種別 |
|--------|---------|------------|------|
| A遺跡  | 報告書B | 縄文時代   | 集落 |
| B遺跡  | 報告書C | 旧石器時代 | 集落 |
| B遺跡  | 報告書D | 古墳時代   | 墳墓 |

データの2行目と3行目が同一の遺跡を示しているからと言って、値(報告書名、時代、種別)を1つのセルにまとめてはいけません。見やすいからとセル内で改行したり、セルを結合するのもいけません。

#### 例2

|       | 竪穴住居 | 土坑 | 土器 |
|-------|:--------:|:----:|:----:|
| A遺跡 |     8    |  12  |  38  |
| B遺跡 |          |   3  |  16  |
| C遺跡 |    25    |  108 |  127 |

クロス集計表はデータ全体の様相を把握するために便利です。しかし整然データの視点から見ると、各遺跡の遺構・遺物の構成を分析するためには以下のように整形すべきです。

| 遺跡名 | 遺構・遺物種別 | 検出数 |
|--------|:--------------:|:------:|
| A遺跡  |    竪穴住居    |    8   |
| A遺跡  |      土坑      |   12   |
| A遺跡  |      土器      |   38   |
| B遺跡  |      土坑      |    3   |
| B遺跡  |      土器      |   16   |
| C遺跡  |    竪穴住居    |   25   |
| C遺跡  |      土坑      |   108  |
| C遺跡  |      土器      |   127  |

遺跡名-遺構・遺物種別-検出数で一組のデータセットであり、一行で記述されます。「竪穴住居」「土坑」「土器」などは、遺構・遺物種別を示す**変数**であり分析の対象として扱われます。

他にも、整然データでないものを整然データに整形する手順・方法はいくつもありますが、以下の実習を通して学んでいきたいと思います。

------------------------------------------------------------------------

## 4.データの取得と確認

リポジトリから東京都遺跡地図全データ(20201017現在、島しょ部を除く6283件)のCSVファイルを取得します。

これは[遺跡地図作成実習part1](https://github.com/kotdijian/JASOSR/tree/master/MappingWokrshop)でも取り扱ったものです。

```{r chunk2, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}
TokyoTotal <- import("https://github.com/kotdijian/JASOSR/raw/master/13Tokyo/13Tokyo_total.csv", setclass= "tbl_df", encoding = "UTF-8") # TokyoTotalに原データcsvを読み込み、エンコードの指定に注意

```

ここでは`rio`パッケージの`import`関数を使用しています。他のパッケージの関数と区別するため`rio::import()`と記述することもできます。

関数名の後ろの()内には、実行条件を示す**引数**(argument)が記述されます。ここではまず""内にデータ取得元のURLが指定され、次に`setclass="tbl_df"`、すなわち**データフレーム**として読み込むことが宣言され、また`encoding = "UTF-8"`としてエンコーディングを指定しています。

**データフレーム**とは、数値や文字列などを含む表(行列)です([参照](http://cse.naro.affrc.go.jp/takezawa/r-tips/r/39.html))。1行目は**ラベル**(項目名)です。データの型(数値、文字列など)は各列ごとに異なっていても構いませんが、同一列の中では同じ型でなければなりません。

読み込みが完了するとEnvironmentウインドウに、`Data: TokyoTotal | 6282 obs. of 12 variables`と表示されます。これは12項目(列または変数)からなる6282件のデータセットが`TokyoTotal`に格納されたことを示します。

データフレーム・オブジェクトは、データ量が多いため**Enviroment**ウインドウには内容が表示されません。オブジェクト名の左の青丸+白三角をクリックすると、各列のラベルとデータ型、項目数、先頭数行分のデータが表示されます。さらにオブジェクト名をダブルクリックすると**Source**ウインドウに内容が表示されます。ここでデータが**文字化け**していないかどうか確認しましょう。

データフレーム・オブジェクトの確認は、以下の通り、`nrow()`関数、`str()`関数、`summary()`関数、によっても実行できます。このうち`nrow()`関数がもっともシンプルなもので、データフレームの行数=レコード数をカウントします。

以下のチャンクをそれぞれ実行してください。

```{r chunk2, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}
#データフレームのレコード数(行数)を確認
nrow(TokyoTotal)
```

```{r chunk3, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}
# データフレームの構造を確認
str(TokyoTotal)
```

```{r chunk4, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}
#データフレームの先頭数行の内容を表示
head(TokyoTotal)
```

```{r chunk5, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}
#データフレームの概要・基礎統計量を表示
summary(TokyoTotal) #数値データ列は、最大最小値、第1・第3四分位値、中央・平均値が計算される

```

------------------------------------------------------------------------

## 5.時代別データの抽出

### 5-1.データセットと方針の確認

「東京都遺跡地図」から取得した原データセットでは、一つの「時代」列に、各遺跡の属性項目が列記されています。単一の時代だけの遺跡は一セルに一つのデータですが、多くの遺跡では一セルに複数のデータが含まれています。

遺跡地図作成実習\#1では、*GoogleSpreadsheet*や*Excel*のフィルター機能を利用して、部分一致で時代名を検索・抽出し、あらたなシートを作成して.csvで保存するという手順で作業をしました。

しかしデータ量が多く、作業の都度、条件指定をしてフィルタリング、コピー・ペーストをするのは手間がかかる上に、手作業ゆえのミスもおきやすいです。そこで、検索や集計を容易にするために、各時代ごとに01ベクトル（その時代の記載があれば1、なければ0）を作成して、TokyoTotalに追加します。

### 5-2. filter関数による抽出

ここでは**dplyr**パッケージの`filter()`関数を使用します。**dplyr**は、最初にインストールした**Tidyverse**パッケージに含まれるため、あらたにインストールする必要はありません。なお、`filter()`関数は同名の関数がほかのパッケージにも含まれているため、環境によっては競合して動作しない場合があります。その際は、`dplyr::filter()`と記述することで、パッケージを特定して実行することができます。

`filter()`関数の構文は以下の通りです。

    `filter(.data, ...)`

    - `data`は、対象とするデータセットをオブジェクト名で指定します。今回は`TokyoTotal`です。
    - `...`はフィルターの条件を指定します。

フィルターを実行した結果を、あらたなオブジェクトに格納してテ保管することで、原データとフィルター後のデータセットを保持します。以下のチャンクを実行してみましょう。

```{r chunk6, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}

TokyoPal1 <- filter(TokyoTotal,時代 == "旧石器時代")

nrow(TokyoPal1)
```

結果は0件でした。フィルターの条件設定に使用した`==`は一致を意味します。TokyoTotalデータセットの**時代**列には"旧石器時代"に一致するデータは1件も含まれていないのです。原データセットを見ると、時代はで括られて表記されています。そこで次のチャンクを実行しましょう。

```{r chunk7, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}

TokyoPal1 <- filter(TokyoTotal,時代 == "[旧石器時代]")

nrow(TokyoPal1)
```

今度は41件が抽出されました。少し少なすぎる気がします。GoogleSpreadsheet上で「"旧石器時代"を含む」でフィルターをかけると683件が抽出されます。この違いは何でしょうか?

繰り返しになりますが、`filter(TokyoTotal,時代 == "[旧石器時代]")`では、抽出条件`[旧石器時代]`を`==`で指定しているので、完全一致のレコード、つまり旧石器時代単独のだけが抽出されています。41件という数値は、旧石器時代単独遺跡の数を指します。

### 5-3. str\_detect()関数を組み合わせて部分一致検索

そこで、抽出条件に`str_detect()`関数を用います。`str_detect()`は**Stringr**パッケージの関数です)で、**Tidyverse**パッケージに含まれています。

次のチャンクを実行してみましょう。

```{r chunk8, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}

TokyoPal1 <- filter(TokyoTotal, str_detect(時代,"旧石器時代"))

nrow(TokyoPal1)
```

今度は683件が抽出され、Spreadsheetによるフィルターと同じ結果を得ることができました。なお、なぜ検索条件が`[旧石器時代]`ではなく、`旧石器時代`なのかについては次項で説明します。

### 5-4. 正規表現について

`str_detect()`関数では、部分一致、前方一致、後方一致など検索条件を簡略に記号で記述することができます。このような記述方法を**正規表現**と呼びます。**R**以外でも、様々なプログラミング言語で使用可能ですが、言語ごとのローカルルールがある場合もありますので、注意してください。

#### 参考

-   [「基本的な正規表現一覧」murashun.jp](https://murashun.jp/blog/20190215-01.html)

先のチャンク8で、検索条件を`[旧石器時代]`ではなく`旧石器時代`としたのも、この**正規表現**が関係します。`[]`は、**含まれる文字列のどれかに一致する**を指定する正規表現なのです。したがって、チャンク8の検索条件を`[旧石器時代]`にすると次のような結果になってしまいます。

```{r chunk9, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}

TokyoPal2 <- filter(TokyoTotal, str_detect(時代,"[旧石器時代]"))

nrow(TokyoPal2)
```

5256件という数字は、実は`旧石器時代`のどれか一文字でも含まれているものを抽出したものです。**東京都遺跡地図**で用いられている時代区分は以下の通りなので、`中世`、`近世`を含まない遺跡が抽出されたことになります。

#### 東京都遺跡地図の時代区分一覧

    - 旧石器時代\
    - 縄文時代\
    - 弥生時代\
    - 古墳時代\
    - 奈良時代\
    - 平安時代\
    - 中世\
    - 近世\
    - 不明\

**正規表現**を用いた抽出の実際は、後ほど実習します。

------------------------------------------------------------------------

## 6.時代区分0-1行列の作成

### 6-1.時代区分行列作成の意味

チャンク8では、`TokyoPal1`という新規のオブジェクト(データフレーム)に`[旧石器時代]`を含むレコードを抽出して格納しました。それでは6282件のレコード全体から、各時代の遺跡数を集計したり、特定の時代(ひとつ、または複数)の遺跡を抽出するにはどうしたらよいでしょうか?

ここまで見てきたやり方を踏襲すると、各時代別の新規のオブジェクトを作成し、それぞれの行数を集計したり、地図作成データにする方法を思いつくかもしれません。

しかし全遺跡が一つのデータセット(データフレーム)となっていることの利便性も捨て難いものがあります。時代別にオブジェクトを分けてしまうと、複数の時代にまたがる操作、分析が煩雑になります。

そこで以下に、`TokyoTotal`に**新規の列を追加**し、旧石器時代～時代不明の9つの属性が、そのレコードに含まれるかどうかを示す**0-1行列**を入力します。

```{r chunk10, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}

#旧石器時代
Tokyo.palaeolithic <- TokyoTotal %>% 
                      filter(str_detect(時代, "旧石器時代")) %>% 
                      mutate(旧石器時代 = "1")

#縄文時代
Tokyo.jomon <- TokyoTotal %>% 
                      filter(str_detect(時代, "縄文時代")) %>% 
                      mutate(縄文時代 = "1")

#弥生時代
Tokyo.yayoi <- TokyoTotal %>% 
                      filter(str_detect(時代, "弥生時代")) %>% 
                      mutate(弥生時代 = "1")

#古墳時代
Tokyo.kofun <- TokyoTotal %>% 
                      filter(str_detect(時代, "古墳時代")) %>% 
                      mutate(古墳時代 = "1")

#奈良時代
Tokyo.nara <- TokyoTotal %>% 
                      filter(str_detect(時代, "奈良時代")) %>% 
                      mutate(奈良時代 = "1")

#平安時代
Tokyo.heian <- TokyoTotal %>% 
                      filter(str_detect(時代, "平安時代")) %>% 
                      mutate(平安時代 = "1")

#中世
Tokyo.medieval <- TokyoTotal %>% 
                      filter(str_detect(時代, "中世")) %>% 
                      mutate(中世 = "1")

#近世
Tokyo.earlymodern <- TokyoTotal %>% 
                      filter(str_detect(時代, "近世")) %>% 
                      mutate(近世 = "1")

#時代不明
Tokyo.unknown <- TokyoTotal %>% 
                      filter(str_detect(時代, "不明")) %>% 
                      mutate(時代不明 = "1")
```

基本はチャンク8と同じですが、新しい関数や表記法が出てきました。以下に解説します。

### 6-2.パイプ演算子

`%>%`は\***パイプ演算子**または単に**パイプ**と呼ばれるものです。繰り返し使用するオブジェクトを何度も入力・記載しなくて済むので便利です。

チャンク10の例について解説します。

`TokyoTotal %>% filter(str_detect(時代, "####")) %>% mutate(旧石器時代 = 1)`

このコードでは、まず最初に`TokyoTotal`というオブジェクトを扱うことを宣言しています。次に**パイプ**`%>%`を用いて宣言を次の`filter()`関数に受け渡します。

チャンク8～9のコードは、`filter(TokyoTotal, 時代, str_detect("####")`でした。これは`TokyoTotal`オブジェクトの`時代`列で`filter()`関数を実行するという指定です。チャンク6～7でも同様に、`filter()`関数のカッコ内の引数の先頭はオブジェクト名です。

一方チャンク10では、`filter(`の直後に直接`str_detect((時代, "####"))`と記述されていて、オブジェクト名が指定されていません。これでも実行できるのは、最初のオブジェクト名の宣言が**パイプ**によって次に受け渡されているからです。同様に、`filter()`関数の後にも**パイプ**があり、次の`mutate()`関数にも受け渡されています。

このように**パイプ**は、つながれている関数等の最初の**引数**に、最初の指定を次々に受け渡すという機能を持っています。チャンクの例では、1つの実行あたり2回しか同じオブジェクトを指定していませんが、これが5回、10回と多くなると、繰り返し入力するのは煩雑になりますし、入力ミスなどのチェックも大変です。そこで作業の効率化とコードの簡略化のために**パイプ**を使用するのです。

なお参考までに、チャンク10と同じ内容を**パイプ**なしで記述すると以下の通りとなります。

`filter(TokyoTotal, str_detect(時代, "####"))`\
`mutate(TokyoTotal, 旧石器時代 = 1)`

### 6-3. mutate()関数

チャンク10で新しく出てきた関数`mutate()`は、データフレームに新規列を作成しデータを追加するものです。

`mutate(オブジェクト名, 追加する列名 = 追加するデータ)`という構文になります。ただしチャンク10では**パイプ**を用いているのでオブジェクト名が省略されています。`##時代 = 1`として、`TokyoTotal`のデータフレームに`##時代`という列を追加した上で、時代ごとに抽出されたレコードに`"1"`の値を与えます。

結果を見てみましょう。なおチャンク10では、原データである`TokyoTotal`にダイレクトに時代区分の0-1行列を追加せず、いったん、時代別のオブジェクトを作成してそこに格納しています。これは後で時代別データセットとして書き出し、分布図作成などに利用するためです。

例として旧石器時代のデータセット`Tokyo.Palaeolithic`の内容を見てみます。

```{r chunk11, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}
head(Tokyo.palaeolithic)

```

原データデータの`TokyoTotal`は12列(項目)×6282行(レコード)のデータフレームでしたが、新規作成した`Tokyo.palaeolithic`は13列×683行のデータフレームとなっています。一番右に新しい列(`旧石器時代)`が加わり1が入力されています。他の時代別のデータフレームも同様です。

### 6-4.オブジェクトの連結・統合

続いて、当初の方針通りに、全体を統合して一つのデータフレームに格納します。`TokyoTotal`に書き加えても良いのですが、ここでは原データセットをそのまま保持することとして、新たな`TokyoTotal.age`というオブジェクトを作成することとします。

原データを保持しておくことは、ミスが発覚した時に検証したり、作業を巻き戻す上で重要です。一方でオブジェクトが増えすぎると煩雑となり管理が難しくなる側面もあります。このあたりは、状況を検討して最適化を図ってください。

またここでは、新たなオブジェクトの列(項目)数が大きくなりすぎるので、新規作成する`TokyoTotal.age`には、地図作成上必要最小限の項目だけを加えることとします。なお必要があれば、これから説明する方法を利用して後から追加することも可能です。

まず新規オブジェクトに加える項目を、`select()`関数で指定します。次に`join()`関数を用いて、各時代データセットを統合していきます。2つの関数はともに**dplyr**パッケージの関数です。当然**Tidyverse**パッケージに含まれています。

それでは次のチャンクを実行してみましょう。

```{r chunk12, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}
#統合:TokyoTotal.ageは遺跡名+位置座標+時期区分のみ
TokyoTotal.age <- TokyoTotal %>% dplyr::select(JASID,自治体コード,遺跡名,緯度,経度) %>%
                      left_join(dplyr::select(Tokyo.palaeolithic, JASID, 旧石器時代),by = "JASID") %>%
                      left_join(dplyr::select(Tokyo.jomon, JASID, 縄文時代),by = "JASID") %>%
                      left_join(dplyr::select(Tokyo.yayoi, JASID, 弥生時代),by = "JASID") %>%
                      left_join(dplyr::select(Tokyo.kofun,JASID,古墳時代),by = "JASID") %>%
                      left_join(dplyr::select(Tokyo.nara,JASID,奈良時代),by = "JASID") %>%
                      left_join(dplyr::select(Tokyo.heian,JASID,平安時代),by = "JASID") %>%
                      left_join(dplyr::select(Tokyo.medieval,JASID,中世),by = "JASID") %>%
                      left_join(dplyr::select(Tokyo.earlymodern,JASID,近世),by = "JASID") %>%
                      left_join(dplyr::select(Tokyo.unknown,JASID,時代不明),by = "JASID")
```

オブジェクト`TokyoTotal`を計10回指定しているので、**パイプ**の有効性が分かりますね。

ここでは、`join()`関数の一用法である、`left_join()`を用いています。以下、チャンク内のコードを解説します。

まず全体に共通するオブジェクトとして`TokyoTotal`を指定し、**パイプ**で受け渡します。次に`select()`関数で'TokyoTotal'の12項目のうち5項目を選択します。

`left_join()`関数は、()内で初め(左側)に指定されたオブジェクトに、次に指定したオブジェクトを結合するものです。ここでは、一連のコードの冒頭で宣言して以下、**パイプ**でつないでいる`TokyoTotal`が結合先、チャンク10で作成した各時代の一覧が結合データセットになります。ただし両者の項目(列)は大部分重複しているので、ここでも`select()`関数で選択したもののみを結合するように指示しています。具体的には、照合のための**JASID**と、各時代の0-1行列が入力される追加された列です。

()内の最後の引数`by =`は、結合先と結合データをつなげるための**キー**を指定します。ここでは、遺跡のUIDとして設定した**JASID**をキーとしています。すなわち、結合データのうち結合先と**JASID**が一致するものだけが付け加えられていくのです。

この処理を、**パイプ**でつないで、時代ごとに計9回実施します。これにより、時代別に作成された0-1行列、すなわち各遺跡における指定の時代の有無が、全遺跡に対して入力されました。

処理内容の複雑さに対する処理速度の速さを実感できたでしょうか。この一連の処理を、SpreadsheetやExcelで手作業で行なった場合、どれだけの手順を繰り返す必要があるでしょうか?

こうした複雑・大量データ処理は、**R**などによるプログラム処理が効果を発揮する分野です。

なお**`filter()`はレコード(行)に対して選択・抽出を行なう**のに対して、**`select()`はラベルで指定した列に対して選択・抽出を行なう**ものです。`select()`はラベルだけでなく列の順番でも指定可能です。

### 6-5.空白(NA)セルを0に置換する

ところで各時代データセットは、それぞれが帰属する時代の列にのみ`1`が入力されており、それ以外は**空白**です。

次のチャンクを実行して確認してみましょう。

```{r chunk12, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}
head(TokyoTotal.age)
```

多くの場合、私たちはデータの`0`と**空白**(データ処理上は`NA`)を区別せず、**空白**のセルは`0`と扱っているでしょう。しかし前者は、観察・計測等を行なった結果が`0`であったことを示すのに対し、後者は何らかの理由で観察・計測が行なわれていないか、行なわれたけれどデータが失われていることを示します。

出土遺物全点を検索・検討した結果、石器が1点も含まれていないことを確認した場合、石器の点数は`0`です。一方、全点の検索・検討が行なわれていない状態で石器の点数が**空白**の場合、石器が**ない(=0)**とは言い切れません。

このように`0`と**空白**(`NA`)は明確に区別する必要があります。

今回の場合、各時代データセットは、他の時代についてのデータを持たないため、そこに含まれないレコードの値は`NA`になります。しかし実際には、全遺跡について各時代の有無をすべて検索しているので、`NA`ではなくて`0`とすべきです。これを一括置換するのが、**tidyr**パッケージの`replace_na()`関数です。

```{r chunk12, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}
# naを一括置換する
TokyoTotal.age <- replace_na(TokyoTotal.age, list(旧石器時代 =0, 縄文時代 =0, 弥生時代 = 0, 古墳時代 = 0, 奈良時代 = 0, 平安時代 = 0, 中世 = 0, 近世 = 0, 時代不明 = 0))

head(TokyoTotal.age)
```

処理が終わったら、新しく作られたTokyoTotal.ageを開いて内容を確認しましょう。

またTokyo.palaeolithic～Tokyo.unknownには各時代ごとの遺跡一覧が収納されています。こちらも確認してみましょう。

なお

        \#\#集計・概要
        各種の集計を実行します。基本は、`group_by()`関数で指定した属性項目ごとにグループ化し、`tally`関数で合計を計算します。計算結果は新しくnと名付けられた項目に収納されるので、`rename()`関数でnを「合計」に変更します。最後に`arrange()`関数で自治体コード順に並び替えをします。

        **集計1:区市町村ごとの遺跡数**

        ```f3175f2a-e8a0-4436-be12-b33925b6d220
        31b8e172-b470-440e-83d8-e6b185028602:dAB5AHAAZQA6AFoAZwBBAHoAQQBEAEUAQQBOAHcAQQAxAEEARwBZAEEATQBnAEIAaABBAEMAMABBAFoAUQBBADQAQQBHAEUAQQBNAEEAQQB0AEEARABRAEEATgBBAEEAegBBAEQAWQBBAEwAUQBCAGkAQQBHAFUAQQBNAFEAQQB5AEEAQwAwAEEAWQBnAEEAegBBAEQATQBBAE8AUQBBAHkAQQBEAFUAQQBZAGcAQQAyAEEARwBRAEEATQBnAEEAeQBBAEQAQQBBAAoAcABvAHMAaQB0AGkAbwBuADoATQBRAEEAMgBBAEQAZwBBAE0AUQBBAHgAQQBBAD0APQAKAHAAcgBlAGYAaQB4ADoACgBzAG8AdQByAGMAZQA6AFkAQQBCAGcAQQBHAEEAQQBlAHcAQgB5AEEAQwBBAEEAWQB3AEIAbwBBAEgAVQBBAGIAZwBCAHIAQQBEAFEAQQBMAEEAQQBnAEEARwBVAEEAZABnAEIAaABBAEcAdwBBAFAAUQBCAFUAQQBGAEkAQQBWAFEAQgBGAEEAQwB3AEEASQBBAEIAbABBAEcATQBBAGEAQQBCAHYAQQBEADAAQQBWAEEAQgBTAEEARgBVAEEAUgBRAEEAcwBBAEMAQQBBAGIAUQBCAGwAQQBIAE0AQQBjAHcAQgBoAEEARwBjAEEAWgBRAEEAOQBBAEUAWQBBAFEAUQBCAE0AQQBGAE0AQQBSAFEAQQBzAEEAQwBBAEEAZAB3AEIAaABBAEgASQBBAGIAZwBCAHAAQQBHADQAQQBaAHcAQQA5AEEARQBZAEEAUQBRAEIATQBBAEYATQBBAFIAUQBCADkAQQBBAG8AQQBWAEEAQgB2AEEARwBzAEEAZQBRAEIAdgBBAEMANABBAGMAdwBCADAAQQBDAEEAQQBQAEEAQQB0AEEAQwBBAEEAVgBBAEIAdgBBAEcAcwBBAGUAUQBCAHYAQQBGAFEAQQBiAHcAQgAwAEEARwBFAEEAYgBBAEEAZwBBAEMAVQBBAFAAZwBBAGwAQQBDAEEAQQBJAEEAQQBLAEEAQwBBAEEASQBBAEIAbgBBAEgASQBBAGIAdwBCADEAQQBIAEEAQQBYAHcAQgBpAEEASABrAEEASwBBAEQAcQBnAGIAdABzAFUAMAArAHoATQBQAHcAdwB5AFQAQQBwAEEAQwBBAEEASgBRAEEAKwBBAEMAVQBBAEMAZwBBAGcAQQBDAEEAQQBkAEEAQgBoAEEARwB3AEEAYgBBAEIANQBBAEMAQQBBAEoAUQBBACsAQQBDAFUAQQBJAEEAQQBLAEEAQwBBAEEASQBBAEIAeQBBAEcAVQBBAGIAZwBCAGgAQQBHADAAQQBaAFEAQQBvAEEAQQBoAFUAQwBJAG8AZwBBAEQAMABBAEkAQQBCAHUAQQBDAGsAQQBJAEEAQQBsAEEARAA0AEEASgBRAEEAZwBBAEEAbwBBAEkAQQBBAGcAQQBHAEUAQQBjAGcAQgB5AEEARwBFAEEAYgBnAEIAbgBBAEcAVQBBAEsAQQBEAHEAZwBiAHQAcwBVADAAKwB6AE0AUAB3AHcAeQBUAEEAcABBAEEAbwBBAEkAQQBBAGcAQQBBAG8AQQBJAHcAQQA2AFUAdwBKAGUATwBuAFYAUgBaAHcAMQBVAC8AWQArAGcAVQBnAG8AQQBJAEEAQQBnAEEAQwBNAEEANgBvAEcANwBiAEYATgBQAEQAVgBSAHUATQBLADIASwBmAHoAQwA4AGoAMwA4AHcASwBBAEIAdABBAEcAOABBAGMAZwBCAGwAQQBDAEEAQQBhAEEAQgAxAEEARwAwAEEAWQBRAEIAdQBBAEMAQQBBAGMAZwBCAGwAQQBHAEUAQQBaAEEAQgBoAEEARwBJAEEAYgBBAEIAbABBAEMAawBBAEMAZwBBAGcAQQBDAEEAQQBUAEEAQgBIAEEARQBNAEEASQBBAEEAOABBAEMAMABBAEkAQQBCAHAAQQBHADAAQQBjAEEAQgB2AEEASABJAEEAZABBAEEAbwBBAEMASQBBAGEAQQBCADAAQQBIAFEAQQBjAEEAQgB6AEEARABvAEEATAB3AEEAdgBBAEcAYwBBAGEAUQBCADAAQQBHAGcAQQBkAFEAQgBpAEEAQwA0AEEAWQB3AEIAdgBBAEcAMABBAEwAdwBCAHIAQQBHADgAQQBkAEEAQgBrAEEARwBrAEEAYQBnAEIAcABBAEcARQBBAGIAZwBBAHYAQQBFAE0AQQBhAEEAQgBwAEEARwBrAEEAYQB3AEIAcABBAEUAcwBBAGIAdwBCADEAQQBHAHMAQQBiAHcAQgBDAEEAQwAwAEEATQBnAEEAdwBBAEQASQBBAE0AQQBBAHYAQQBIAEkAQQBZAFEAQgAzAEEAQwA4AEEAYgBRAEIAaABBAEgATQBBAGQAQQBCAGwAQQBIAEkAQQBMAHcAQQB4AEEARABNAEEAVgBBAEIAdgBBAEcAcwBBAGUAUQBCAHYAQQBDADgAQQBUAEEAQgBIAEEARQBNAEEAWAB3AEEAeABBAEQATQBBAFYAQQBCAHYAQQBHAHMAQQBlAFEAQgB2AEEAQwA0AEEAWQB3AEIAegBBAEgAWQBBAEkAZwBBAHMAQQBDAEEAQQBjAHcAQgBsAEEASABRAEEAWQB3AEIAcwBBAEcARQBBAGMAdwBCAHoAQQBEADAAQQBJAEEAQQBpAEEASABRAEEAWQBnAEIAcwBBAEYAOABBAFoAQQBCAG0AQQBDAEkAQQBMAEEAQQBnAEEARwBVAEEAYgBnAEIAagBBAEcAOABBAFoAQQBCAHAAQQBHADQAQQBaAHcAQQBnAEEARAAwAEEASQBnAEIAVgBBAEYAUQBBAFIAZwBBAHQAQQBEAGcAQQBJAGcAQQBnAEEAQwBrAEEASQBBAEEAagBBAEUAdwBBAFIAdwBCAEQAQQBGADgAQQBNAFEAQQB6AEEARgBRAEEAYgB3AEIAcgBBAEgAawBBAGIAdwBBAHUAQQBHAE0AQQBjAHcAQgAyAEEARAAwAEEAYwBXAGUAcwBUAHYAMgBRADYAbwBHADcAYgBGAE4AUABzAHoARAA4AE0ATQBrAHcANgBqAEMANQBNAE0AZwB3AEEAVABEAHEAZwBiAHQAcwBVADAAKwB6AE0AUAB3AHcAeQBUAEIAZwBNAEYARQB3AFoAegBCAHYATQBBAFoAUwBTAHoAQwBLAE0ARwBVAHcAaQBUAEIARQBNAEcANAB3AFoAegBEAHEAZwBiAHQAcwBVADAAOABOAFYASgBJAHcALwBZACsAZwBVAGwAYwB3AGYAagBCAFoATQBBAG8AQQBDAGcAQgBVAEEARwA4AEEAYQB3AEIANQBBAEcAOABBAEwAZwBCAHoAQQBIAFEAQQBJAEEAQQA4AEEAQwAwAEEASQBBAEIAdABBAEgAVQBBAGQAQQBCAGgAQQBIAFEAQQBaAFEAQQBvAEEARgBRAEEAYgB3AEIAcgBBAEgAawBBAGIAdwBBAHUAQQBIAE0AQQBkAEEAQQBzAEEARABwAFQAQQBsADQANgBkAFYARgBuAEQAVgBRAGcAQQBEADAAQQBJAEEAQQBpAEEAQwBJAEEASwBRAEEAZwBBAEMATQBBAHgAcABZAEkAaQB1AG8AdwB1AFQARABJAE0ARwBzAHcATwBsAE0AQwBYAGoAcAAxAFUAVwBjAE4AVgBHADQAdwBCAFoAagB1AGQAcABJAHcALwBZACsAZwBVAGcAbwBBAFYAQQBCAHYAQQBHAHMAQQBlAFEAQgB2AEEAQwA0AEEAYwB3AEIAMABBAEMAQQBBAFAAQQBBAHQAQQBDAEEAQQBaAEEAQgB3AEEARwB3AEEAZQBRAEIAeQBBAEQAbwBBAE8AZwBCAHoAQQBHAFUAQQBiAEEAQgBsAEEARwBNAEEAZABBAEEAbwBBAEYAUQBBAGIAdwBCAHIAQQBIAGsAQQBiAHcAQQB1AEEASABNAEEAZABBAEEAcwBBAE8AcQBCAHUAMgB4AFQAVAA3AE0AdwAvAEQARABKAE0AQwB3AEEATwBsAE0AQwBYAGoAcAAxAFUAVwBjAE4AVgBDAHcAQQBDAEYAUQBJAGkAaQBrAEEASQBBAEEAagBBAEIAZABTAEQAVgBSAHUATQBDAFoATwBlAFQARAAvAFoAawBnAHcAQwBnAEEASwBBAEcATQBBAGQAQQBCAHkAQQBDAEEAQQBQAEEAQQB0AEEAQwBBAEEATQBRAEEANgBBAEcANABBAGMAZwBCAHYAQQBIAGMAQQBLAEEAQgBVAEEARwA4AEEAYQB3AEIANQBBAEcAOABBAEwAZwBCAHoAQQBIAFEAQQBLAFEAQQBnAEEAQwBNAEEAeABwAFkASQBpAHUAbwB3AHUAVABEAEkATQBHADQAdwBUAEkAaAB3AFoAWgBJAHcAMQBsAE8AWABYAHcAbwBBAFQAQQBCAEgAQQBFAE0AQQBZAHcAQgB2AEEARwBRAEEAWgBRAEEAZwBBAEQAdwBBAEwAUQBBAGcAQQBHAFEAQQBjAEEAQgBzAEEASABrAEEAYwBnAEEANgBBAEQAbwBBAGMAdwBCAGwAQQBHAHcAQQBaAFEAQgBqAEEASABRAEEASwBBAEIAVQBBAEcAOABBAGEAdwBCADUAQQBHADgAQQBMAGcAQgB6AEEASABRAEEATABBAEQAcQBnAGIAdABzAFUAMAArAHoATQBQAHcAdwB5AFQAQQBwAEEAQwBBAEEASQB3AEQARwBsAGcAaQBLADYAagBDADUATQBNAGcAdwBiAGoARABxAGcAYgB0AHMAVQAwACsAegBNAFAAdwB3AHkAVABCAHUATQBIADgAdwBrAGoAQgBNAEEARQBjAEEAUQB3AEIAagBBAEcAOABBAFoAQQBCAGwAQQBHAHMAdwB6AGwATQBOAGYAUQBvAEEAWgBnAEIAdgBBAEgASQBBAEkAQQBBAG8AQQBHAGsAQQBJAEEAQgBwAEEARwA0AEEASQBBAEIAagBBAEgAUQBBAGMAZwBBAHAAQQBIAHMAQQBJAEEAQQBqAEEATQBhAFcAQwBJAHIAcQBNAEwAawB3AHkARABCAHUATQBFAHkASQBjAEcAVQBHAFUAbgBCACsAaQBqAEQAVQBqADEAYwB3ADUAbABFAEcAZABBAG8AQQBJAEEAQQBnAEEARwB3AEEAWgB3AEIAagBBAEcATQBBAEkAQQBBADgAQQBDADAAQQBJAEEAQQBvAEEARQB3AEEAUgB3AEIARABBAEcATQBBAGIAdwBCAGsAQQBHAFUAQQBXAHcAQgBwAEEAQwB3AEEATQBRAEIAZABBAEMAawBBAFcAdwBCAGIAQQBEAEUAQQBYAFEAQgBkAEEAQQBvAEEASQBBAEEAZwBBAEcAdwBBAFoAdwBCAHUAQQBHAEUAQQBiAFEAQgBsAEEAQwBBAEEAUABBAEEAdABBAEMAQQBBAEsAQQBCAGsAQQBIAEEAQQBiAEEAQgA1AEEASABJAEEATwBnAEEANgBBAEgATQBBAFoAUQBCAHMAQQBHAFUAQQBZAHcAQgAwAEEAQwBnAEEASwBBAEIAbQBBAEcAawBBAGIAQQBCADAAQQBHAFUAQQBjAGcAQQBvAEEARQB3AEEAUgB3AEIARABBAEMAdwBBADYAbwBHADcAYgBGAE4AUABzAHoARAA4AE0ATQBrAHcASQBBAEEAOQBBAEQAMABBAEkAQQBCAHMAQQBHAGMAQQBZAHcAQgBqAEEAQwBrAEEASwBRAEEAcwBBAEEAMQBVADgASABrAHAAQQBDAGsAQQBXAHcAQgBiAEEARABFAEEAWABRAEIAZABBAEEAbwBBAEkAQQBBAGcAQQBGAFEAQQBiAHcAQgByAEEASABrAEEAYgB3AEEAdQBBAEgATQBBAGQAQQBCAGIAQQBHAGsAQQBMAEEAQQBpAEEARABwAFQAQQBsADQANgBkAFYARgBuAEQAVgBRAGkAQQBGADAAQQBJAEEAQQA4AEEAQwAwAEEASQBBAEIAcwBBAEcAYwBBAGIAZwBCAGgAQQBHADAAQQBaAFEAQQBLAEEASAAwAEEAQwBnAEEASwBBAEYAUQBBAGIAdwBCAHIAQQBIAGsAQQBiAHcAQQB1AEEASABNAEEAZABBAEEASwBBAEcAQQBBAFkAQQBCAGcAQQBBAD0APQAKAHMAdQBmAGYAaQB4ADoA:31b8e172-b470-440e-83d8-e6b185028602

    自治体名の追加には、`for()`関数を使用して繰り返し処理を適用しています。`l:nrow()`でTokyo.stの列数=データ件数を取得してctrに収納、ctr回繰り返し自治体コードに一致する自治体名を「名称」に追加するという処理を実行します。具体的には5313件の照合と追加を行なっていますが、処理速度を体感してください。
    最後に一覧を表示します。

    **時代別**

    ```f3175f2a-e8a0-4436-be12-b33925b6d220
    31b8e172-b470-440e-83d8-e6b185028602:dAB5AHAAZQA6AFoAZwBBAHoAQQBEAEUAQQBOAHcAQQAxAEEARwBZAEEATQBnAEIAaABBAEMAMABBAFoAUQBBADQAQQBHAEUAQQBNAEEAQQB0AEEARABRAEEATgBBAEEAegBBAEQAWQBBAEwAUQBCAGkAQQBHAFUAQQBNAFEAQQB5AEEAQwAwAEEAWQBnAEEAegBBAEQATQBBAE8AUQBBAHkAQQBEAFUAQQBZAGcAQQAyAEEARwBRAEEATQBnAEEAeQBBAEQAQQBBAAoAcABvAHMAaQB0AGkAbwBuADoATQBnAEEAMgBBAEQARQBBAE0AdwBBADAAQQBBAD0APQAKAHAAcgBlAGYAaQB4ADoACgBzAG8AdQByAGMAZQA6AFkAQQBCAGcAQQBHAEEAQQBlAHcAQgB5AEEAQwBBAEEAWQB3AEIAbwBBAEgAVQBBAGIAZwBCAHIAQQBEAFUAQQBMAEEAQQBnAEEARwBVAEEAZABnAEIAaABBAEcAdwBBAFAAUQBCAFUAQQBGAEkAQQBWAFEAQgBGAEEAQwB3AEEASQBBAEIAbABBAEcATQBBAGEAQQBCAHYAQQBEADAAQQBWAEEAQgBTAEEARgBVAEEAUgBRAEEAcwBBAEMAQQBBAGIAUQBCAGwAQQBIAE0AQQBjAHcAQgBoAEEARwBjAEEAWgBRAEEAOQBBAEUAWQBBAFEAUQBCAE0AQQBGAE0AQQBSAFEAQQBzAEEAQwBBAEEAZAB3AEIAaABBAEgASQBBAGIAZwBCAHAAQQBHADQAQQBaAHcAQQA5AEEARQBZAEEAUQBRAEIATQBBAEYATQBBAFIAUQBCADkAQQBBAG8AQQBJAHcARABHAGwAZwBpAEsATQBnAEEANgBBAEUASgBtADQAMAA0AGwAVQBnAG8AQQBJAEEAQQBnAEEAQwBNAEEASQBBAEQAbgBaAGYATgAzAGEARgBZAEsAQQBDAEEAQQBJAEEAQgBVAEEARwA4AEEAYQB3AEIANQBBAEcAOABBAEwAZwBCAHoAQQBIAFEAQQBNAGcAQQBnAEEARAB3AEEATABRAEEAZwBBAEYAUQBBAGIAdwBCAHIAQQBIAGsAQQBiAHcAQgBVAEEARwA4AEEAZABBAEIAaABBAEcAdwBBAEwAZwBCAGgAQQBHAGMAQQBaAFEAQQBnAEEAQwBVAEEAUABnAEEAbABBAEMAQQBBAEMAZwBBAGcAQQBDAEEAQQBJAEEAQQBnAEEARwBjAEEAYwBnAEIAdgBBAEgAVQBBAGMAQQBCAGYAQQBHAEkAQQBlAFEAQQBvAEEATwBxAEIAdQAyAHgAVABUADcATQB3AC8ARABEAEoATQBDAHcAQQBJAEEARABuAFoAZgBOADMAYQBGAFoAQwBaAHUATgBPAEsAUQBBAEEATQBDAFUAQQBQAGcAQQBsAEEAQQBvAEEASQBBAEEAZwBBAEMAQQBBAEkAQQBCADAAQQBHAEUAQQBiAEEAQgBzAEEASABrAEEASQBBAEEAbABBAEQANABBAEoAUQBBAGcAQQBBAG8AQQBJAEEAQQBnAEEAQwBBAEEASQBBAEIAegBBAEgAQQBBAGMAZwBCAGwAQQBHAEUAQQBaAEEAQQBvAEEATwBkAGwAOAAzAGQAbwBWAGsASgBtADQAMAA0AHMAQQBHADQAQQBLAFEAQQBnAEEAQwBVAEEAUABnAEEAbABBAEMAQQBBAEMAZwBBAGcAQQBDAEEAQQBJAEEAQQBnAEEASABJAEEAWgBRAEIAdQBBAEcARQBBAGIAUQBCAGwAQQBDAGcAQQBJAGcARABuAFoAZgBOADMAYQBGAFkAaQBBAEMAQQBBAFAAUQBBAGcAQQBDAEkAQQBNAFEAQQBpAEEAQwBrAEEASQBBAEEAbABBAEQANABBAEoAUQBBAGcAQQBBAG8AQQBJAEEAQQBnAEEAQwBBAEEASQBBAEIAawBBAEgAQQBBAGIAQQBCADUAQQBIAEkAQQBPAGcAQQA2AEEASABNAEEAWgBRAEIAcwBBAEcAVQBBAFkAdwBCADAAQQBDAGcAQQBMAFEAQQBpAEEARABBAEEASQBnAEEAcABBAEEAbwBBAEkAQQBBAGcAQQBGAFEAQQBiAHcAQgByAEEASABrAEEAYgB3AEEAdQBBAEgATQBBAGQAQQBBAGcAQQBEAHcAQQBMAFEAQQBnAEEARwB3AEEAWgBRAEIAbQBBAEgAUQBBAFgAdwBCAHEAQQBHADgAQQBhAFEAQgB1AEEAQwBnAEEAVgBBAEIAdgBBAEcAcwBBAGUAUQBCAHYAQQBDADQAQQBjAHcAQgAwAEEAQwB3AEEASQBBAEIAVQBBAEcAOABBAGEAdwBCADUAQQBHADgAQQBMAGcAQgB6AEEASABRAEEATQBnAEEAcwBBAEMAQQBBAFkAZwBCADUAQQBDAEEAQQBQAFEAQQBnAEEAQwBJAEEANgBvAEcANwBiAEYATgBQAHMAegBEADgATQBNAGsAdwBJAGcAQQBwAEEAQQBvAEEAQwBnAEEAZwBBAEMAQQBBAEkAdwBBAGcAQQBBAFIAKwBoADIAVQBLAEEAQwBBAEEASQBBAEIAVQBBAEcAOABBAGEAdwBCADUAQQBHADgAQQBMAGcAQgB6AEEASABRAEEATQBnAEEAZwBBAEQAdwBBAEwAUQBBAGcAQQBGAFEAQQBiAHcAQgByAEEASABrAEEAYgB3AEIAVQBBAEcAOABBAGQAQQBCAGgAQQBHAHcAQQBMAGcAQgBoAEEARwBjAEEAWgBRAEEAZwBBAEMAVQBBAFAAZwBBAGwAQQBDAEEAQQBDAGcAQQBnAEEAQwBBAEEASQBBAEEAZwBBAEcAYwBBAGMAZwBCAHYAQQBIAFUAQQBjAEEAQgBmAEEARwBJAEEAZQBRAEEAbwBBAE8AcQBCAHUAMgB4AFQAVAA3AE0AdwAvAEQARABKAE0AQwB3AEEASQBBAEEARQBmAG8AZABsAFEAbQBiAGoAVABpAGsAQQBBAEQAQQBsAEEARAA0AEEASgBRAEEASwBBAEMAQQBBAEkAQQBBAGcAQQBDAEEAQQBkAEEAQgBoAEEARwB3AEEAYgBBAEIANQBBAEMAQQBBAEoAUQBBACsAQQBDAFUAQQBJAEEAQQBLAEEAQwBBAEEASQBBAEEAZwBBAEMAQQBBAGMAdwBCAHcAQQBIAEkAQQBaAFEAQgBoAEEARwBRAEEASwBBAEEARQBmAG8AZABsAFEAbQBiAGoAVABpAHcAQQBiAGcAQQBwAEEAQwBBAEEASgBRAEEAKwBBAEMAVQBBAEkAQQBBAEsAQQBDAEEAQQBJAEEAQQBnAEEAQwBBAEEAYwBnAEIAbABBAEcANABBAFkAUQBCAHQAQQBHAFUAQQBLAEEAQQBpAEEAQQBSACsAaAAyAFUAaQBBAEMAQQBBAFAAUQBBAGcAQQBDAEkAQQBNAFEAQQBpAEEAQwBrAEEASQBBAEEAbABBAEQANABBAEoAUQBBAGcAQQBBAG8AQQBJAEEAQQBnAEEAQwBBAEEASQBBAEIAawBBAEgAQQBBAGIAQQBCADUAQQBIAEkAQQBPAGcAQQA2AEEASABNAEEAWgBRAEIAcwBBAEcAVQBBAFkAdwBCADAAQQBDAGcAQQBMAFEAQQBpAEEARABBAEEASQBnAEEAcABBAEEAbwBBAEkAQQBBAGcAQQBGAFEAQQBiAHcAQgByAEEASABrAEEAYgB3AEEAdQBBAEgATQBBAGQAQQBBAGcAQQBEAHcAQQBMAFEAQQBnAEEARwB3AEEAWgBRAEIAbQBBAEgAUQBBAFgAdwBCAHEAQQBHADgAQQBhAFEAQgB1AEEAQwBnAEEAVgBBAEIAdgBBAEcAcwBBAGUAUQBCAHYAQQBDADQAQQBjAHcAQgAwAEEAQwB3AEEASQBBAEIAVQBBAEcAOABBAGEAdwBCADUAQQBHADgAQQBMAGcAQgB6AEEASABRAEEATQBnAEEAcwBBAEMAQQBBAFkAZwBCADUAQQBDAEEAQQBQAFEAQQBnAEEAQwBJAEEANgBvAEcANwBiAEYATgBQAHMAegBEADgATQBNAGsAdwBJAGcAQQBwAEEAQQBvAEEAQwBnAEEAZwBBAEMAQQBBAEkAdwBBAGcAQQBDAFYAZgBIADMAVQBLAEEAQwBBAEEASQBBAEIAVQBBAEcAOABBAGEAdwBCADUAQQBHADgAQQBMAGcAQgB6AEEASABRAEEATQBnAEEAZwBBAEQAdwBBAEwAUQBBAGcAQQBGAFEAQQBiAHcAQgByAEEASABrAEEAYgB3AEIAVQBBAEcAOABBAGQAQQBCAGgAQQBHAHcAQQBMAGcAQgBoAEEARwBjAEEAWgBRAEEAZwBBAEMAVQBBAFAAZwBBAGwAQQBDAEEAQQBDAGcAQQBnAEEAQwBBAEEASQBBAEEAZwBBAEcAYwBBAGMAZwBCAHYAQQBIAFUAQQBjAEEAQgBmAEEARwBJAEEAZQBRAEEAbwBBAE8AcQBCAHUAMgB4AFQAVAA3AE0AdwAvAEQARABKAE0AQwB3AEEASQBBAEEAbABYAHgAOQAxAFEAbQBiAGoAVABpAGsAQQBBAEQAQQBsAEEARAA0AEEASgBRAEEASwBBAEMAQQBBAEkAQQBBAGcAQQBDAEEAQQBkAEEAQgBoAEEARwB3AEEAYgBBAEIANQBBAEMAQQBBAEoAUQBBACsAQQBDAFUAQQBJAEEAQQBLAEEAQwBBAEEASQBBAEEAZwBBAEMAQQBBAGMAdwBCAHcAQQBIAEkAQQBaAFEAQgBoAEEARwBRAEEASwBBAEEAbABYAHgAOQAxAFEAbQBiAGoAVABpAHcAQQBiAGcAQQBwAEEAQwBBAEEASgBRAEEAKwBBAEMAVQBBAEkAQQBBAEsAQQBDAEEAQQBJAEEAQQBnAEEAQwBBAEEAYwBnAEIAbABBAEcANABBAFkAUQBCAHQAQQBHAFUAQQBLAEEAQQBpAEEAQwBWAGYASAAzAFUAaQBBAEMAQQBBAFAAUQBBAGcAQQBDAEkAQQBNAFEAQQBpAEEAQwBrAEEASQBBAEEAbABBAEQANABBAEoAUQBBAGcAQQBBAG8AQQBJAEEAQQBnAEEAQwBBAEEASQBBAEIAawBBAEgAQQBBAGIAQQBCADUAQQBIAEkAQQBPAGcAQQA2AEEASABNAEEAWgBRAEIAcwBBAEcAVQBBAFkAdwBCADAAQQBDAGcAQQBMAFEAQQBpAEEARABBAEEASQBnAEEAcABBAEEAbwBBAEkAQQBBAGcAQQBGAFEAQQBiAHcAQgByAEEASABrAEEAYgB3AEEAdQBBAEgATQBBAGQAQQBBAGcAQQBEAHcAQQBMAFEAQQBnAEEARwB3AEEAWgBRAEIAbQBBAEgAUQBBAFgAdwBCAHEAQQBHADgAQQBhAFEAQgB1AEEAQwBnAEEAVgBBAEIAdgBBAEcAcwBBAGUAUQBCAHYAQQBDADQAQQBjAHcAQgAwAEEAQwB3AEEASQBBAEIAVQBBAEcAOABBAGEAdwBCADUAQQBHADgAQQBMAGcAQgB6AEEASABRAEEATQBnAEEAcwBBAEMAQQBBAFkAZwBCADUAQQBDAEEAQQBQAFEAQQBnAEEAQwBJAEEANgBvAEcANwBiAEYATgBQAHMAegBEADgATQBNAGsAdwBJAGcAQQBwAEEAQQBvAEEAQwBnAEEAZwBBAEMAQQBBAEkAdwBBAGcAQQBPAFIAVABzADEAZwBLAEEAQwBBAEEASQBBAEIAVQBBAEcAOABBAGEAdwBCADUAQQBHADgAQQBMAGcAQgB6AEEASABRAEEATQBnAEEAZwBBAEQAdwBBAEwAUQBBAGcAQQBGAFEAQQBiAHcAQgByAEEASABrAEEAYgB3AEIAVQBBAEcAOABBAGQAQQBCAGgAQQBHAHcAQQBMAGcAQgBoAEEARwBjAEEAWgBRAEEAZwBBAEMAVQBBAFAAZwBBAGwAQQBDAEEAQQBDAGcAQQBnAEEAQwBBAEEASQBBAEEAZwBBAEcAYwBBAGMAZwBCAHYAQQBIAFUAQQBjAEEAQgBmAEEARwBJAEEAZQBRAEEAbwBBAE8AcQBCAHUAMgB4AFQAVAA3AE0AdwAvAEQARABKAE0AQwB3AEEASQBBAEQAawBVADcATgBZAFEAbQBiAGoAVABpAGsAQQBBAEQAQQBsAEEARAA0AEEASgBRAEEASwBBAEMAQQBBAEkAQQBBAGcAQQBDAEEAQQBkAEEAQgBoAEEARwB3AEEAYgBBAEIANQBBAEMAQQBBAEoAUQBBACsAQQBDAFUAQQBJAEEAQQBLAEEAQwBBAEEASQBBAEEAZwBBAEMAQQBBAGMAdwBCAHcAQQBIAEkAQQBaAFEAQgBoAEEARwBRAEEASwBBAEQAawBVADcATgBZAFEAbQBiAGoAVABpAHcAQQBiAGcAQQBwAEEAQwBBAEEASgBRAEEAKwBBAEMAVQBBAEkAQQBBAEsAQQBDAEEAQQBJAEEAQQBnAEEAQwBBAEEAYwBnAEIAbABBAEcANABBAFkAUQBCAHQAQQBHAFUAQQBLAEEAQQBpAEEATwBSAFQAcwAxAGcAaQBBAEMAQQBBAFAAUQBBAGcAQQBDAEkAQQBNAFEAQQBpAEEAQwBrAEEASQBBAEEAbABBAEQANABBAEoAUQBBAGcAQQBBAG8AQQBJAEEAQQBnAEEAQwBBAEEASQBBAEIAawBBAEgAQQBBAGIAQQBCADUAQQBIAEkAQQBPAGcAQQA2AEEASABNAEEAWgBRAEIAcwBBAEcAVQBBAFkAdwBCADAAQQBDAGcAQQBMAFEAQQBpAEEARABBAEEASQBnAEEAcABBAEEAbwBBAEkAQQBBAGcAQQBGAFEAQQBiAHcAQgByAEEASABrAEEAYgB3AEEAdQBBAEgATQBBAGQAQQBBAGcAQQBEAHcAQQBMAFEAQQBnAEEARwB3AEEAWgBRAEIAbQBBAEgAUQBBAFgAdwBCAHEAQQBHADgAQQBhAFEAQgB1AEEAQwBnAEEAVgBBAEIAdgBBAEcAcwBBAGUAUQBCAHYAQQBDADQAQQBjAHcAQgAwAEEAQwB3AEEASQBBAEIAVQBBAEcAOABBAGEAdwBCADUAQQBHADgAQQBMAGcAQgB6AEEASABRAEEATQBnAEEAcwBBAEMAQQBBAFkAZwBCADUAQQBDAEEAQQBQAFEAQQBnAEEAQwBJAEEANgBvAEcANwBiAEYATgBQAHMAegBEADgATQBNAGsAdwBJAGcAQQBwAEEAQQBvAEEAQwBnAEEAZwBBAEMAQQBBAEkAdwBBAGcAQQBFAGgAWgBiADQASQBLAEEAQwBBAEEASQBBAEIAVQBBAEcAOABBAGEAdwBCADUAQQBHADgAQQBMAGcAQgB6AEEASABRAEEATQBnAEEAZwBBAEQAdwBBAEwAUQBBAGcAQQBGAFEAQQBiAHcAQgByAEEASABrAEEAYgB3AEIAVQBBAEcAOABBAGQAQQBCAGgAQQBHAHcAQQBMAGcAQgBoAEEARwBjAEEAWgBRAEEAZwBBAEMAVQBBAFAAZwBBAGwAQQBDAEEAQQBDAGcAQQBnAEEAQwBBAEEASQBBAEEAZwBBAEcAYwBBAGMAZwBCAHYAQQBIAFUAQQBjAEEAQgBmAEEARwBJAEEAZQBRAEEAbwBBAE8AcQBCAHUAMgB4AFQAVAA3AE0AdwAvAEQARABKAE0AQwB3AEEASQBBAEIASQBXAFcAKwBDAFEAbQBiAGoAVABpAGsAQQBBAEQAQQBsAEEARAA0AEEASgBRAEEASwBBAEMAQQBBAEkAQQBBAGcAQQBDAEEAQQBkAEEAQgBoAEEARwB3AEEAYgBBAEIANQBBAEMAQQBBAEoAUQBBACsAQQBDAFUAQQBJAEEAQQBLAEEAQwBBAEEASQBBAEEAZwBBAEMAQQBBAGMAdwBCAHcAQQBIAEkAQQBaAFEAQgBoAEEARwBRAEEASwBBAEIASQBXAFcAKwBDAFEAbQBiAGoAVABpAHcAQQBiAGcAQQBwAEEAQwBBAEEASgBRAEEAKwBBAEMAVQBBAEkAQQBBAEsAQQBDAEEAQQBJAEEAQQBnAEEAQwBBAEEAYwBnAEIAbABBAEcANABBAFkAUQBCAHQAQQBHAFUAQQBLAEEAQQBpAEEARQBoAFoAYgA0AEkAaQBBAEMAQQBBAFAAUQBBAGcAQQBDAEkAQQBNAFEAQQBpAEEAQwBrAEEASQBBAEEAbABBAEQANABBAEoAUQBBAGcAQQBBAG8AQQBJAEEAQQBnAEEAQwBBAEEASQBBAEIAawBBAEgAQQBBAGIAQQBCADUAQQBIAEkAQQBPAGcAQQA2AEEASABNAEEAWgBRAEIAcwBBAEcAVQBBAFkAdwBCADAAQQBDAGcAQQBMAFEAQQBpAEEARABBAEEASQBnAEEAcABBAEEAbwBBAEkAQQBBAGcAQQBGAFEAQQBiAHcAQgByAEEASABrAEEAYgB3AEEAdQBBAEgATQBBAGQAQQBBAGcAQQBEAHcAQQBMAFEAQQBnAEEARwB3AEEAWgBRAEIAbQBBAEgAUQBBAFgAdwBCAHEAQQBHADgAQQBhAFEAQgB1AEEAQwBnAEEAVgBBAEIAdgBBAEcAcwBBAGUAUQBCAHYAQQBDADQAQQBjAHcAQgAwAEEAQwB3AEEASQBBAEIAVQBBAEcAOABBAGEAdwBCADUAQQBHADgAQQBMAGcAQgB6AEEASABRAEEATQBnAEEAcwBBAEMAQQBBAFkAZwBCADUAQQBDAEEAQQBQAFEAQQBnAEEAQwBJAEEANgBvAEcANwBiAEYATgBQAHMAegBEADgATQBNAGsAdwBJAGcAQQBwAEEAQQBvAEEAQwBnAEEAZwBBAEMAQQBBAEkAdwBBAGcAQQBIAE4AZQBpAFYAcwBLAEEAQwBBAEEASQBBAEIAVQBBAEcAOABBAGEAdwBCADUAQQBHADgAQQBMAGcAQgB6AEEASABRAEEATQBnAEEAZwBBAEQAdwBBAEwAUQBBAGcAQQBGAFEAQQBiAHcAQgByAEEASABrAEEAYgB3AEIAVQBBAEcAOABBAGQAQQBCAGgAQQBHAHcAQQBMAGcAQgBoAEEARwBjAEEAWgBRAEEAZwBBAEMAVQBBAFAAZwBBAGwAQQBDAEEAQQBDAGcAQQBnAEEAQwBBAEEASQBBAEEAZwBBAEcAYwBBAGMAZwBCAHYAQQBIAFUAQQBjAEEAQgBmAEEARwBJAEEAZQBRAEEAbwBBAE8AcQBCAHUAMgB4AFQAVAA3AE0AdwAvAEQARABKAE0AQwB3AEEASQBBAEIAegBYAG8AbABiAFEAbQBiAGoAVABpAGsAQQBBAEQAQQBsAEEARAA0AEEASgBRAEEASwBBAEMAQQBBAEkAQQBBAGcAQQBDAEEAQQBkAEEAQgBoAEEARwB3AEEAYgBBAEIANQBBAEMAQQBBAEoAUQBBACsAQQBDAFUAQQBJAEEAQQBLAEEAQwBBAEEASQBBAEEAZwBBAEMAQQBBAGMAdwBCAHcAQQBIAEkAQQBaAFEAQgBoAEEARwBRAEEASwBBAEIAegBYAG8AbABiAFEAbQBiAGoAVABpAHcAQQBiAGcAQQBwAEEAQwBBAEEASgBRAEEAKwBBAEMAVQBBAEkAQQBBAEsAQQBDAEEAQQBJAEEAQQBnAEEAQwBBAEEAYwBnAEIAbABBAEcANABBAFkAUQBCAHQAQQBHAFUAQQBLAEEAQQBpAEEASABOAGUAaQBWAHMAaQBBAEMAQQBBAFAAUQBBAGcAQQBDAEkAQQBNAFEAQQBpAEEAQwBrAEEASQBBAEEAbABBAEQANABBAEoAUQBBAGcAQQBBAG8AQQBJAEEAQQBnAEEAQwBBAEEASQBBAEIAawBBAEgAQQBBAGIAQQBCADUAQQBIAEkAQQBPAGcAQQA2AEEASABNAEEAWgBRAEIAcwBBAEcAVQBBAFkAdwBCADAAQQBDAGcAQQBMAFEAQQBpAEEARABBAEEASQBnAEEAcABBAEEAbwBBAEkAQQBBAGcAQQBGAFEAQQBiAHcAQgByAEEASABrAEEAYgB3AEEAdQBBAEgATQBBAGQAQQBBAGcAQQBEAHcAQQBMAFEAQQBnAEEARwB3AEEAWgBRAEIAbQBBAEgAUQBBAFgAdwBCAHEAQQBHADgAQQBhAFEAQgB1AEEAQwBnAEEAVgBBAEIAdgBBAEcAcwBBAGUAUQBCAHYAQQBDADQAQQBjAHcAQgAwAEEAQwB3AEEASQBBAEIAVQBBAEcAOABBAGEAdwBCADUAQQBHADgAQQBMAGcAQgB6AEEASABRAEEATQBnAEEAcwBBAEMAQQBBAFkAZwBCADUAQQBDAEEAQQBQAFEAQQBnAEEAQwBJAEEANgBvAEcANwBiAEYATgBQAHMAegBEADgATQBNAGsAdwBJAGcAQQBwAEEAQQBvAEEAQwBnAEEAZwBBAEMAQQBBAEkAdwBBAGcAQQBDADEATwBGAGsANABLAEEAQwBBAEEASQBBAEIAVQBBAEcAOABBAGEAdwBCADUAQQBHADgAQQBMAGcAQgB6AEEASABRAEEATQBnAEEAZwBBAEQAdwBBAEwAUQBBAGcAQQBGAFEAQQBiAHcAQgByAEEASABrAEEAYgB3AEIAVQBBAEcAOABBAGQAQQBCAGgAQQBHAHcAQQBMAGcAQgBoAEEARwBjAEEAWgBRAEEAZwBBAEMAVQBBAFAAZwBBAGwAQQBDAEEAQQBDAGcAQQBnAEEAQwBBAEEASQBBAEEAZwBBAEcAYwBBAGMAZwBCAHYAQQBIAFUAQQBjAEEAQgBmAEEARwBJAEEAZQBRAEEAbwBBAE8AcQBCAHUAMgB4AFQAVAA3AE0AdwAvAEQARABKAE0AQwB3AEEASQBBAEEAdABUAGgAWgBPAEsAUQBBAEEATQBDAFUAQQBQAGcAQQBsAEEAQQBvAEEASQBBAEEAZwBBAEMAQQBBAEkAQQBCADAAQQBHAEUAQQBiAEEAQgBzAEEASABrAEEASQBBAEEAbABBAEQANABBAEoAUQBBAGcAQQBBAG8AQQBJAEEAQQBnAEEAQwBBAEEASQBBAEIAegBBAEgAQQBBAGMAZwBCAGwAQQBHAEUAQQBaAEEAQQBvAEEAQwAxAE8ARgBrADQAcwBBAEcANABBAEsAUQBBAGcAQQBDAFUAQQBQAGcAQQBsAEEAQwBBAEEAQwBnAEEAZwBBAEMAQQBBAEkAQQBBAGcAQQBIAEkAQQBaAFEAQgB1AEEARwBFAEEAYgBRAEIAbABBAEMAZwBBAEkAZwBBAHQAVABoAFoATwBJAGcAQQBnAEEARAAwAEEASQBBAEEAaQBBAEQARQBBAEkAZwBBAHAAQQBDAEEAQQBKAFEAQQArAEEAQwBVAEEASQBBAEEASwBBAEMAQQBBAEkAQQBBAGcAQQBDAEEAQQBaAEEAQgB3AEEARwB3AEEAZQBRAEIAeQBBAEQAbwBBAE8AZwBCAHoAQQBHAFUAQQBiAEEAQgBsAEEARwBNAEEAZABBAEEAbwBBAEMAMABBAEkAZwBBAHcAQQBDAEkAQQBLAFEAQQBLAEEAQwBBAEEASQBBAEIAVQBBAEcAOABBAGEAdwBCADUAQQBHADgAQQBMAGcAQgB6AEEASABRAEEASQBBAEEAOABBAEMAMABBAEkAQQBCAHMAQQBHAFUAQQBaAGcAQgAwAEEARgA4AEEAYQBnAEIAdgBBAEcAawBBAGIAZwBBAG8AQQBGAFEAQQBiAHcAQgByAEEASABrAEEAYgB3AEEAdQBBAEgATQBBAGQAQQBBAHMAQQBDAEEAQQBWAEEAQgB2AEEARwBzAEEAZQBRAEIAdgBBAEMANABBAGMAdwBCADAAQQBEAEkAQQBMAEEAQQBnAEEARwBJAEEAZQBRAEEAZwBBAEQAMABBAEkAQQBBAGkAQQBPAHEAQgB1ADIAeABUAFQANwBNAHcALwBEAEQASgBNAEMASQBBAEsAUQBBAEsAQQBBAG8AQQBJAEEAQQBnAEEAQwBNAEEASQBBAEQAUgBqAHgAWgBPAEMAZwBBAGcAQQBDAEEAQQBWAEEAQgB2AEEARwBzAEEAZQBRAEIAdgBBAEMANABBAGMAdwBCADAAQQBEAEkAQQBJAEEAQQA4AEEAQwAwAEEASQBBAEIAVQBBAEcAOABBAGEAdwBCADUAQQBHADgAQQBWAEEAQgB2AEEASABRAEEAWQBRAEIAcwBBAEMANABBAFkAUQBCAG4AQQBHAFUAQQBJAEEAQQBsAEEARAA0AEEASgBRAEEAZwBBAEEAbwBBAEkAQQBBAGcAQQBDAEEAQQBJAEEAQgBuAEEASABJAEEAYgB3AEIAMQBBAEgAQQBBAFgAdwBCAGkAQQBIAGsAQQBLAEEARABxAGcAYgB0AHMAVQAwACsAegBNAFAAdwB3AHkAVABBAHMAQQBDAEEAQQAwAFkAOABXAFQAaQBrAEEAQQBEAEEAbABBAEQANABBAEoAUQBBAEsAQQBDAEEAQQBJAEEAQQBnAEEAQwBBAEEAZABBAEIAaABBAEcAdwBBAGIAQQBCADUAQQBDAEEAQQBKAFEAQQArAEEAQwBVAEEASQBBAEEASwBBAEMAQQBBAEkAQQBBAGcAQQBDAEEAQQBjAHcAQgB3AEEASABJAEEAWgBRAEIAaABBAEcAUQBBAEsAQQBEAFIAagB4AFoATwBMAEEAQgB1AEEAQwBrAEEASQBBAEEAbABBAEQANABBAEoAUQBBAGcAQQBBAG8AQQBJAEEAQQBnAEEAQwBBAEEASQBBAEIAeQBBAEcAVQBBAGIAZwBCAGgAQQBHADAAQQBaAFEAQQBvAEEAQwBJAEEAMABZADgAVwBUAGkASQBBAEkAQQBBADkAQQBDAEEAQQBJAGcAQQB4AEEAQwBJAEEASwBRAEEAZwBBAEMAVQBBAFAAZwBBAGwAQQBDAEEAQQBDAGcAQQBnAEEAQwBBAEEASQBBAEEAZwBBAEcAUQBBAGMAQQBCAHMAQQBIAGsAQQBjAGcAQQA2AEEARABvAEEAYwB3AEIAbABBAEcAdwBBAFoAUQBCAGoAQQBIAFEAQQBLAEEAQQB0AEEAQwBJAEEATQBBAEEAaQBBAEMAawBBAEMAZwBBAGcAQQBDAEEAQQBWAEEAQgB2AEEARwBzAEEAZQBRAEIAdgBBAEMANABBAGMAdwBCADAAQQBDAEEAQQBQAEEAQQB0AEEAQwBBAEEAYgBBAEIAbABBAEcAWQBBAGQAQQBCAGYAQQBHAG8AQQBiAHcAQgBwAEEARwA0AEEASwBBAEIAVQBBAEcAOABBAGEAdwBCADUAQQBHADgAQQBMAGcAQgB6AEEASABRAEEATABBAEEAZwBBAEYAUQBBAGIAdwBCAHIAQQBIAGsAQQBiAHcAQQB1AEEASABNAEEAZABBAEEAeQBBAEMAdwBBAEkAQQBCAGkAQQBIAGsAQQBJAEEAQQA5AEEAQwBBAEEASQBnAEQAcQBnAGIAdABzAFUAMAArAHoATQBQAHcAdwB5AFQAQQBpAEEAQwBrAEEAQwBnAEEASwBBAEMAQQBBAEkAQQBBAGoAQQBDAEEAQQBRAG0AYgBqAFQAZwAxAE8ARABtAFkASwBBAEMAQQBBAEkAQQBCAFUAQQBHADgAQQBhAHcAQgA1AEEARwA4AEEATABnAEIAegBBAEgAUQBBAE0AZwBBAGcAQQBEAHcAQQBMAFEAQQBnAEEARgBRAEEAYgB3AEIAcgBBAEgAawBBAGIAdwBCAFUAQQBHADgAQQBkAEEAQgBoAEEARwB3AEEATABnAEIAaABBAEcAYwBBAFoAUQBBAGcAQQBDAFUAQQBQAGcAQQBsAEEAQwBBAEEAQwBnAEEAZwBBAEMAQQBBAEkAQQBBAGcAQQBHAGMAQQBjAGcAQgB2AEEASABVAEEAYwBBAEIAZgBBAEcASQBBAGUAUQBBAG8AQQBPAHEAQgB1ADIAeABUAFQANwBNAHcALwBEAEQASgBNAEMAdwBBAEkAQQBCAEMAWgB1AE4ATwBEAFUANABPAFoAaQBrAEEAQQBEAEEAbABBAEQANABBAEoAUQBBAEsAQQBDAEEAQQBJAEEAQQBnAEEAQwBBAEEAZABBAEIAaABBAEcAdwBBAGIAQQBCADUAQQBDAEEAQQBKAFEAQQArAEEAQwBVAEEASQBBAEEASwBBAEMAQQBBAEkAQQBBAGcAQQBDAEEAQQBjAHcAQgB3AEEASABJAEEAWgBRAEIAaABBAEcAUQBBAEsAQQBCAEMAWgB1AE4ATwBEAFUANABPAFoAaQB3AEEAYgBnAEEAcABBAEMAQQBBAEoAUQBBACsAQQBDAFUAQQBJAEEAQQBLAEEAQwBBAEEASQBBAEEAZwBBAEMAQQBBAGMAZwBCAGwAQQBHADQAQQBZAFEAQgB0AEEARwBVAEEASwBBAEEAaQBBAEUASgBtADQAMAA0AE4AVABnADUAbQBJAGcAQQBnAEEARAAwAEEASQBBAEEAaQBBAEQARQBBAEkAZwBBAHAAQQBDAEEAQQBKAFEAQQArAEEAQwBVAEEASQBBAEEASwBBAEMAQQBBAEkAQQBBAGcAQQBDAEEAQQBaAEEAQgB3AEEARwB3AEEAZQBRAEIAeQBBAEQAbwBBAE8AZwBCAHoAQQBHAFUAQQBiAEEAQgBsAEEARwBNAEEAZABBAEEAbwBBAEMAMABBAEkAZwBBAHcAQQBDAEkAQQBLAFEAQQBLAEEAQwBBAEEASQBBAEIAVQBBAEcAOABBAGEAdwBCADUAQQBHADgAQQBMAGcAQgB6AEEASABRAEEASQBBAEEAOABBAEMAMABBAEkAQQBCAHMAQQBHAFUAQQBaAGcAQgAwAEEARgA4AEEAYQBnAEIAdgBBAEcAawBBAGIAZwBBAG8AQQBGAFEAQQBiAHcAQgByAEEASABrAEEAYgB3AEEAdQBBAEgATQBBAGQAQQBBAHMAQQBDAEEAQQBWAEEAQgB2AEEARwBzAEEAZQBRAEIAdgBBAEMANABBAGMAdwBCADAAQQBEAEkAQQBMAEEAQQBnAEEARwBJAEEAZQBRAEEAZwBBAEQAMABBAEkAQQBBAGkAQQBPAHEAQgB1ADIAeABUAFQANwBNAHcALwBEAEQASgBNAEMASQBBAEsAUQBBAEsAQQBDAEEAQQBJAEEAQQBLAEEAQwBBAEEASQBBAEEAagBBAEMAQQBBAFQAZwBCAEIAQQBKAEkAdwBNAEEAQgByAE0ARwA1AC8AMgAyAE0ASwBBAEMAQQBBAEkAQQBCAFUAQQBHADgAQQBhAHcAQgA1AEEARwA4AEEATABnAEIAegBBAEgAUQBBAFcAdwBCAHAAQQBIAE0AQQBMAGcAQgB1AEEARwBFAEEASwBBAEIAVQBBAEcAOABBAGEAdwBCADUAQQBHADgAQQBMAGcAQgB6AEEASABRAEEASwBRAEIAZABBAEMAQQBBAFAAQQBBAHQAQQBDAEEAQQBNAEEAQQBLAEEAQQBvAEEAVgBBAEIAdgBBAEcAcwBBAGUAUQBCAHYAQQBDADQAQQBjAHcAQgAwAEEAQQBvAEEAWQBBAEIAZwBBAEcAQQBBAAoAcwB1AGYAZgBpAHgAOgA=:31b8e172-b470-440e-83d8-e6b185028602

**順列を自治体コードから河川水系別に変更**
自治体コードによる順列では地理的な感覚が捉えづらいので、河川水系別のデータを追加して順列を変更します。
集計リストにバーグラフを追加するformattableパッケージを使用して、表の見た目を変更します。

```{r chunk6, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}
  # 水系リストを読み込み・結合
  river <- import("https://github.com/kotdijian/ChiikiKoukoB-2020/raw/master/13Tokyo/13Tokyo_river.csv", setclass = "tbl_df", encoding="UTF-8")
  Tokyo.stable <- Tokyo.st %>% 
    inner_join(river, by = "自治体コード") %>% 
    dplyr::select("水系", "配列", "自治体コード", "名称", "合計", "旧石器", "縄文", "弥生", "古墳", "奈良", "平安", "中世", "近世", "時代不明")
  
  
# 表形式で表示
  #河川水系でソート
  Tokyo.stable <- arrange(Tokyo.stable, 配列)
  
  #formattableで表出力
  formattable(Tokyo.stable,list(合計=color_bar("tomato"),
                           旧石器=color_bar("blue"),
                           縄文=color_bar("brown"),
                           弥生=color_bar("orange"),
                           古墳=color_bar("green"),
                           奈良=color_bar("purple"),
                           平安=color_bar("yellow"),
                           中世=color_bar("pink"),
                           近世=color_bar("skyblue"),
                           時代不明=color_bar("lightgrey")))

```

**時代別・遺跡種別の集計**

```{r chunk7, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}
#集計2:遺跡種別
  # 列名整理
TokyoTotal2 <- rename(TokyoTotal, "遺構" = "主な遺構/概要") #属性項目名に/(スラッシュ)が入っているとデータ処理の正規表現に影響するため項目名を変更

  # 時代追加
Tokyo.totage <- dplyr::select(TokyoTotal.age,-自治体コード, -遺跡名, -緯度, -経度)
TokyoTotal2 <- left_join(TokyoTotal2, Tokyo.totage, by = "JASID")

  # ベースリスト
Tokyo.sp <- dplyr::select(Tokyo.st,自治体コード,区市町村名)

  # 縄文貝塚
    #リスト
      Tokyo.Jkaizuka <- TokyoTotal2 %>% 
        filter(縄文時代 == 1) %>% 
        filter(str_detect(種別, "貝塚"))
    #集計
      Tokyo.st2 <- TokyoTotal2 %>%
        filter(str_detect(種別, "貝塚")) %>% 
        group_by(自治体コード)　%>%
        tally %>% 
        rename("貝塚" = "n")
      Tokyo.sp <- left_join(Tokyo.sp, Tokyo.st2, by = "自治体コード")
  
  # 方形周溝墓
    #リスト
      Tokyo.Yshukoubo <- TokyoTotal2 %>% 
        filter(弥生時代 == 1) %>% 
        filter(str_detect(遺構, "方形周溝墓"))
    #集計
      Tokyo.st2 <- TokyoTotal2 %>% 
        filter(str_detect(遺構,"方形周溝墓")) %>% 
        group_by(自治体コード) %>% 
        tally() %>% 
        rename("方形周溝墓" = "n")
      Tokyo.sp <- left_join(Tokyo.sp, Tokyo.st2, by = "自治体コード")
  
  # 古墳
    #リスト
      Tokyo.Kkofun <- TokyoTotal2 %>% 
        filter(古墳時代 == 1) %>% 
        filter(str_detect(種別, "古墳"))
    #集計
      Tokyo.st2 <- TokyoTotal2 %>% 
        filter(str_detect(種別,"古墳")) %>% 
        group_by(自治体コード) %>% 
        tally %>% 
        rename("古墳" = "n")
      Tokyo.sp <- left_join(Tokyo.sp, Tokyo.st2, by = "自治体コード")
  
  # 横穴墓
    #リスト
      Tokyo.Kyokoana <- TokyoTotal2 %>% 
        filter(古墳時代 == 1) %>% 
        filter(str_detect(種別, "横穴墓"))
    #集計
      Tokyo.st2 <- TokyoTotal2 %>% 
        filter(str_detect(種別,"横穴墓")) %>% 
        group_by(自治体コード) %>% 
        tally %>% 
        rename("横穴墓" = "n")
      Tokyo.sp <- left_join(Tokyo.sp, Tokyo.st2, by = "自治体コード")
  
  # 社寺
    #リスト
      Tokyo.temple <- TokyoTotal2 %>% 
        filter(str_detect(種別, "社寺"))
    #集計
      Tokyo.st2 <- TokyoTotal2 %>% 
        filter(str_detect(種別,"社寺")) %>% 
        group_by(自治体コード) %>% 
        tally %>% 
        rename("社寺" = "n")
      Tokyo.sp <- left_join(Tokyo.sp, Tokyo.st2, by = "自治体コード")
  
  # 城跡
    #リスト
      Tokyo.Mjokan <- TokyoTotal2 %>% 
        filter(中世 == 1) %>% 
        filter(str_detect(種別, "城館"))
    #集計
      Tokyo.st2 <- TokyoTotal2 %>% 
        filter(中世 ==1) %>% 
        filter(str_detect(種別,"城館")) %>% 
        group_by(自治体コード) %>% 
        tally %>% 
        rename("城館" = "n")
      Tokyo.sp <- left_join(Tokyo.sp, Tokyo.st2, by = "自治体コード")
  
  # 塚
    #リスト
      Tokyo.Mtsuka <- TokyoTotal2 %>% 
        filter(str_detect(種別, "塚"))
    #集計
      Tokyo.st2 <- TokyoTotal2 %>% 
        filter(str_detect(種別,"塚")) %>% 
        group_by(自治体コード) %>% 
        tally %>% 
        rename("塚" = "n")
      Tokyo.sp <- left_join(Tokyo.sp, Tokyo.st2, by = "自治体コード")

  # NAを0に置換
  Tokyo.sp[is.na(Tokyo.sp)] <- 0
  
   # 水系リストを読み込み・結合
  Tokyo.sp <- Tokyo.sp %>% 
    inner_join(river, by = "自治体コード") %>% 
    dplyr::select("水系", "配列", "自治体コード", "名称", "貝塚", "方形周溝墓", "古墳", "横穴墓", "社寺", "城館", "塚")
  
  #河川水系でソート
  Tokyo.sp <- arrange(Tokyo.sp, 配列)
  
  #formattableで表出力
  formattable(Tokyo.sp,list(貝塚=color_bar("blue"),
                           方形周溝墓=color_bar("orange"),
                           古墳=color_bar("green"),
                           社寺=color_bar("yellow"),
                           城館=color_bar("red"),
                           塚=color_bar("purple"),
                           横穴墓=color_bar("brown")
                           )
            )

```

## 作業結果保存

チャンク7までの作業結果をCSVで保存します。

```{r chunk8, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}
write.csv(TokyoTotal, "13Tokyo_total.csv", row.names = FALSE, fileEncoding = "UTF-8") #UTF-8書き出し, ファイル名を適宜指定(全レコード)
write.csv(TokyoTotal.age, "13Tokyo_totalAge.csv", row.names = FALSE, fileEncoding = "UTF-8")
write.csv(site.st, "13Tokyo_summary.csv", row.names = FALSE, fileEncoding = "UTF-8") #集計データ書き出し
write.csv(site.sp, "13Tokyo_sitetype.csv", row.names =FALSE, fileEncoding = "UTF-8") #集計データ(種別)書き出し

#時代別データ書き出し
write.csv(site.palaeolithic, "13Tokyo_total_palaeolithic.csv", row.names=FALSE, fileEncoding = "UTF-8")
write.csv(site.jomon, "13Tokyo_total_jomon.csv", row.names=FALSE, fileEncoding = "UTF-8")
write.csv(site.yayoi, "13Tokyo_total_yayoi.csv", row.names=FALSE, fileEncoding = "UTF-8")
write.csv(site.kofun, "13Tokyo_total_kofun.csv", row.names=FALSE, fileEncoding = "UTF-8")
write.csv(site.nara, "13Tokyo_total_nara.csv", row.names=FALSE, fileEncoding = "UTF-8")
write.csv(site.heian, "13Tokyo_total_heian.csv", row.names=FALSE, fileEncoding = "UTF-8")
write.csv(site.medieval, "13Tokyo_total_medieval.csv", row.names=FALSE, fileEncoding = "UTF-8")
write.csv(site.earlymodern, "13Tokyo_total_earlymodern.csv", row.names=FALSE, fileEncoding = "UTF-8")
write.csv(site.unknown, "13Tokyo_total_unknown.csv", row.names=FALSE, fileEncoding = "UTF-8")

```

書き出したファイルは、.Rmdを保存している先と同じフォルダ(作業ディレクトリ)に保存されます。作業ディレクトリが定かでないときは、Consoleウインドウに`getwd()`と入力すると確認できます。

「ひなたGIS」に読み込ませるためには、エンコーディングをUTF-8ではなくシフトJISにしなければなりません。RではCP932がシフトJISに対応します。
また「ひなたGIS」では座標値のないデータはエラーを出して読み込みをストップします。Googleマイマップなどでは[ヌル島](https://ja.wikipedia.org/wiki/%E3%83%8C%E3%83%AB%E5%B3%B6)が発生するので、座標値のないデータを削除して保存する必要があります。

```{r chunk9, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}
TokyoTotal.coord <- drop_na(TokyoTotal,経度)
write.csv(TokyoTotal.coord, "13Tokyo_totalcoordSJS.csv", row.names = FALSE, fileEncoding = "CP932")　#Shift-JIS書き出し, ファイル名を適宜指定(全レコード)

#時代別データ書き出し
Tokyo.palaeolithic <- drop_na(Tokyo.palaeolithic,経度)
write.csv(Tokyo.palaeolithic, "13Tokyo_total_palaeolithicSJS.csv", row.names=FALSE, fileEncoding = "CP932")

Tokyo.jomon <- drop_na(Tokyo.jomon,経度)
write.csv(Tokyo.jomon, "13Tokyo_total_jomonSJS.csv", row.names=FALSE, fileEncoding = "CP932")

Tokyo.yayoi<- drop_na(Tokyo.yayoi,経度)
write.csv(Tokyo.yayoi, "13Tokyo_total_yayoiSJS.csv", row.names=FALSE, fileEncoding = "CP932")

Tokyo.kofun <- drop_na(Tokyo.kofun,経度)
write.csv(Tokyo.kofun, "13Tokyo_total_kofunSJS.csv", row.names=FALSE, fileEncoding = "CP932")

Tokyo.nara <- drop_na(Tokyo.nara,経度)
write.csv(Tokyo.nara, "13Tokyo_total_naraSJS.csv", row.names=FALSE, fileEncoding = "CP932")

Tokyo.heian <- drop_na(Tokyo.heian,経度)
write.csv(Tokyo.heian, "13Tokyo_total_heianSJS.csv", row.names=FALSE, fileEncoding = "CP932")

Tokyo.medieval <- drop_na(Tokyo.medieval,経度)
write.csv(Tokyo.medieval, "13Tokyo_total_medievalSJS.csv", row.names=FALSE, fileEncoding = "CP932")

Tokyo.earlymodern <- drop_na(Tokyo.earlymodern,経度)
write.csv(Tokyo.earlymodern, "13Tokyo_total_earlymodernSJS.csv", row.names=FALSE, fileEncoding = "CP932")

Tokyo.unknown <- drop_na(Tokyo.unknown,経度)
write.csv(Tokyo.unknown, "13Tokyo_total_unknownSJS.csv", row.names=FALSE, fileEncoding = "CP932")

```

基礎的なデータの操作は以上です。各関数の引数を変更して結果を確認しながら操作を覚えてください。また類似する関数を使用することで異なる結果を得ることも可能です。
ウェブ上では、日本語によるR、とくにTidyverseの解説が多数閲覧できます。それらも参照すると良いでしょう。
一例として...https://kazutan.github.io/kazutanR/hands\_on\_170730/index.html
